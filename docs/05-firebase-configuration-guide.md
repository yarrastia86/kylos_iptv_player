# Kylos IPTV Player - Firebase Configuration Guide

## Document Version

| Version | Date       | Author          | Description                     |
|---------|------------|-----------------|--------------------------------|
| 1.0     | 2024-01-XX | Development     | Initial Firebase setup guide    |

---

## Table of Contents

1. [Prerequisites](#1-prerequisites)
2. [Firebase Project Setup](#2-firebase-project-setup)
3. [FlutterFire CLI Configuration](#3-flutterfire-cli-configuration)
4. [Authentication Setup](#4-authentication-setup)
5. [Firestore Database Setup](#5-firestore-database-setup)
6. [Remote Config Setup](#6-remote-config-setup)
7. [Platform-Specific Configuration](#7-platform-specific-configuration)
8. [Testing the Integration](#8-testing-the-integration)
9. [Troubleshooting](#9-troubleshooting)

---

## 1. Prerequisites

Before starting, ensure you have:

- [ ] A Google account
- [ ] Flutter SDK installed (3.2.0 or higher)
- [ ] Dart SDK (included with Flutter)
- [ ] Access to [Firebase Console](https://console.firebase.google.com)
- [ ] Node.js installed (for Firebase CLI, optional)

### Install Required Tools

```bash
# Install FlutterFire CLI globally
dart pub global activate flutterfire_cli

# Verify installation
flutterfire --version

# (Optional) Install Firebase CLI for advanced features
npm install -g firebase-tools
firebase login
```

---

## 2. Firebase Project Setup

### 2.1 Create Firebase Project

1. Go to [Firebase Console](https://console.firebase.google.com)
2. Click **Add project**
3. Enter project name: `kylos-iptv-player` (or your preferred name)
4. Enable/disable Google Analytics as needed
5. Click **Create project**

### 2.2 Register Platform Apps

#### Android App

1. In Firebase Console, click **Add app** > **Android**
2. Enter Android package name: `com.kylos.iptv_player`
3. Enter app nickname: `Kylos IPTV Player (Android)`
4. Enter SHA-1 certificate fingerprint (required for Google Sign-In):

```bash
# Debug SHA-1 (for development)
cd android
./gradlew signingReport

# Look for "SHA1" under "Variant: debug"
```

5. Download `google-services.json`
6. Place it in `android/app/google-services.json`

#### iOS App

1. Click **Add app** > **iOS**
2. Enter iOS bundle ID: `com.kylos.iptvPlayer`
3. Enter app nickname: `Kylos IPTV Player (iOS)`
4. Download `GoogleService-Info.plist`
5. Place it in `ios/Runner/GoogleService-Info.plist`

#### Android TV / Fire TV

Use the same Android configuration. These platforms share the Android app registration.

---

## 3. FlutterFire CLI Configuration

### 3.1 Run FlutterFire Configure

From your project root directory:

```bash
flutterfire configure
```

This interactive command will:
- Detect your Firebase project
- Generate platform-specific configuration files
- Create `lib/firebase_options.dart`

### 3.2 Select Platforms

When prompted, select:
- [x] android
- [x] ios
- [ ] macos (optional)
- [ ] web (optional)

### 3.3 Update Bootstrap

After configuration, update `lib/bootstrap.dart` to use the generated options:

```dart
// Uncomment this import
import 'firebase_options.dart';

// Update the bootstrap call in main_*.dart files
bootstrap(
  formFactor: FormFactor.mobile,
  firebaseOptions: DefaultFirebaseOptions.currentPlatform,
);
```

### 3.4 Verify Configuration

Your project should now have:

```
lib/
  firebase_options.dart    # Generated by FlutterFire CLI

android/
  app/
    google-services.json   # Android configuration

ios/
  Runner/
    GoogleService-Info.plist  # iOS configuration
```

---

## 4. Authentication Setup

### 4.1 Enable Authentication Providers

In Firebase Console > **Authentication** > **Sign-in method**:

#### Anonymous Authentication

1. Click **Anonymous**
2. Toggle **Enable**
3. Click **Save**

> **Note:** Anonymous auth allows users to start using the app immediately. They can upgrade to a full account later.

#### Email/Password Authentication

1. Click **Email/Password**
2. Toggle **Enable**
3. (Optional) Enable **Email link (passwordless sign-in)**
4. Click **Save**

#### Google Sign-In

1. Click **Google**
2. Toggle **Enable**
3. Enter **Project support email**
4. Click **Save**

**Additional Android Setup:**

1. Go to **Project settings** > **Your apps** > Android app
2. Add SHA-1 and SHA-256 fingerprints:

```bash
# Debug fingerprints
cd android && ./gradlew signingReport

# Release fingerprints (when you have a keystore)
keytool -list -v -keystore your-release-key.keystore -alias your-alias
```

**Additional iOS Setup:**

1. Open `ios/Runner/Info.plist`
2. Add the reversed client ID as a URL scheme:

```xml
<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleTypeRole</key>
    <string>Editor</string>
    <key>CFBundleURLSchemes</key>
    <array>
      <!-- Replace with your reversed client ID from GoogleService-Info.plist -->
      <string>com.googleusercontent.apps.YOUR-CLIENT-ID</string>
    </array>
  </dict>
</array>
```

Find your reversed client ID in `GoogleService-Info.plist` under `REVERSED_CLIENT_ID`.

### 4.2 Configure OAuth Consent Screen (Google Sign-In)

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Select your Firebase project
3. Navigate to **APIs & Services** > **OAuth consent screen**
4. Choose **External** user type
5. Fill in required fields:
   - App name: `Kylos IPTV Player`
   - User support email: your email
   - Developer contact: your email
6. Add scopes: `email`, `profile`, `openid`
7. Save and continue

---

## 5. Firestore Database Setup

### 5.1 Create Firestore Database

1. In Firebase Console > **Firestore Database**
2. Click **Create database**
3. Choose **Start in production mode**
4. Select a location closest to your users
5. Click **Enable**

### 5.2 Deploy Security Rules

In Firebase Console > **Firestore Database** > **Rules**, replace the default rules with:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user has admin claim
    function isAdmin() {
      return isAuthenticated() &&
             request.auth.token.admin == true;
    }

    // Validate timestamp is server time
    function isValidTimestamp(field) {
      return request.resource.data[field] == request.time;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================

    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);

      // Users can create their own document (on first sign-in)
      allow create: if isOwner(userId) &&
                       request.resource.data.uid == userId;

      // Users can update their own document with restrictions
      allow update: if isOwner(userId) &&
                       // Cannot change uid
                       request.resource.data.uid == resource.data.uid;

      // Users cannot delete their document directly (use Cloud Function)
      allow delete: if false;

      // ----------------------------------------
      // PROFILES SUB-COLLECTION
      // ----------------------------------------
      match /profiles/{profileId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // ----------------------------------------
      // PLAYLISTS SUB-COLLECTION
      // ----------------------------------------
      match /playlists/{playlistId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId) &&
                         // Validate required fields
                         request.resource.data.keys().hasAll(['name', 'type']);

        allow update: if isOwner(userId);

        allow delete: if isOwner(userId);
      }

      // ----------------------------------------
      // DEVICES SUB-COLLECTION
      // ----------------------------------------
      match /devices/{deviceId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    // ============================================
    // ENTITLEMENTS COLLECTION (PROTECTED)
    // ============================================

    match /entitlements/{userId} {
      // Users can only read their own entitlements
      allow read: if isOwner(userId);

      // NO direct writes - only Cloud Functions can modify
      allow write: if false;

      match /purchases/{purchaseId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
    }

    // ============================================
    // APP CONFIG (READ-ONLY FOR CLIENTS)
    // ============================================

    match /app_config/{configId} {
      // All authenticated users can read app config
      allow read: if isAuthenticated();

      // Only admins can write (or use Firebase Console)
      allow write: if isAdmin();
    }

    // ============================================
    // ANALYTICS EVENTS (WRITE-ONLY)
    // ============================================

    match /analytics_events/{eventId} {
      // Clients can write analytics events
      allow create: if isAuthenticated();

      // No reads or updates from client
      allow read, update, delete: if false;
    }
  }
}
```

Click **Publish** to deploy the rules.

### 5.3 Create Required Indexes

In Firebase Console > **Firestore Database** > **Indexes** > **Composite**, create:

| Collection | Fields | Query Scope |
|------------|--------|-------------|
| `users/{userId}/playlists` | `sortOrder` ASC, `createdAt` DESC | Collection |
| `entitlements` | `currentTier` ASC, `expiresAt` ASC | Collection |

### 5.4 Create App Config Documents

In Firebase Console > **Firestore Database** > **Data**, create:

#### Document: `/app_config/limits`

```json
{
  "free": {
    "maxProfiles": 2,
    "maxPlaylists": 1,
    "maxFavorites": 50,
    "epgDaysAvailable": 1,
    "cloudSyncEnabled": false
  },
  "pro": {
    "maxProfiles": 10,
    "maxPlaylists": 10,
    "maxFavorites": 500,
    "epgDaysAvailable": 7,
    "cloudSyncEnabled": true
  }
}
```

#### Document: `/app_config/products`

```json
{
  "products": {
    "kylos_pro_monthly": {
      "name": "Kylos Pro Monthly",
      "tier": "pro",
      "type": "subscription",
      "features": ["unlimited_profiles", "cloud_sync", "no_ads", "hd_playback"],
      "platforms": {
        "google_play": "kylos_pro_monthly",
        "app_store": "kylos_pro_monthly",
        "amazon": "kylos_pro_monthly_amazon"
      }
    },
    "kylos_pro_annual": {
      "name": "Kylos Pro Annual",
      "tier": "pro",
      "type": "subscription",
      "features": ["unlimited_profiles", "cloud_sync", "no_ads", "hd_playback"],
      "platforms": {
        "google_play": "kylos_pro_annual",
        "app_store": "kylos_pro_annual",
        "amazon": "kylos_pro_annual_amazon"
      }
    }
  }
}
```

#### Document: `/app_config/features`

```json
{
  "minAppVersion": {
    "android": "1.0.0",
    "ios": "1.0.0",
    "android_tv": "1.0.0"
  },
  "forceUpdate": false,
  "maintenanceMode": false,
  "maintenanceMessage": null
}
```

---

## 6. Remote Config Setup

### 6.1 Create Remote Config Parameters

In Firebase Console > **Remote Config**:

1. Click **Add parameter** for each of the following:

| Parameter Key | Default Value | Description |
|--------------|---------------|-------------|
| `epg_enabled` | `true` | Enable EPG feature |
| `vod_enabled` | `true` | Enable VOD feature |
| `series_enabled` | `true` | Enable Series feature |
| `catch_up_enabled` | `false` | Enable Catch-up TV |
| `multi_audio_enabled` | `true` | Enable multi-audio tracks |
| `subtitles_enabled` | `true` | Enable subtitles |
| `parental_controls_enabled` | `true` | Enable parental controls |
| `cloud_sync_enabled` | `true` | Enable cloud sync |
| `new_player_enabled` | `false` | Enable new player (A/B test) |
| `force_update` | `false` | Force app update |
| `maintenance_mode` | `false` | Enable maintenance mode |
| `maintenance_message` | `""` | Maintenance message text |
| `min_app_version_android` | `"1.0.0"` | Minimum Android version |
| `min_app_version_ios` | `"1.0.0"` | Minimum iOS version |
| `min_app_version_android_tv` | `"1.0.0"` | Minimum Android TV version |

2. Click **Publish changes**

### 6.2 Create Conditions (Optional)

For A/B testing or gradual rollouts:

1. Go to **Conditions** tab
2. Click **Add condition**
3. Example conditions:
   - `Beta Users`: User in random percentile <= 10%
   - `Android TV`: Platform == Android AND App ID contains "tv"
   - `Pro Users`: (Requires custom user property)

---

## 7. Platform-Specific Configuration

### 7.1 Android Configuration

#### Update `android/build.gradle`

```gradle
buildscript {
    dependencies {
        // Add Google Services plugin
        classpath 'com.google.gms:google-services:4.4.0'
    }
}
```

#### Update `android/app/build.gradle`

```gradle
plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'dev.flutter.flutter-gradle-plugin'
    id 'com.google.gms.google-services'  // Add this line
}

android {
    // ... existing config

    defaultConfig {
        // Ensure minSdkVersion is at least 21 for Firebase
        minSdkVersion 21
        // ...
    }
}

dependencies {
    // Firebase BoM for consistent versions
    implementation platform('com.google.firebase:firebase-bom:32.7.0')
}
```

#### Verify `google-services.json`

Ensure the file is at `android/app/google-services.json` and contains:
- Correct `package_name`
- Valid `client_id` and `api_key`

### 7.2 iOS Configuration

#### Update `ios/Podfile`

```ruby
platform :ios, '13.0'  # Minimum iOS 13 for Firebase

# ... rest of Podfile
```

#### Verify `GoogleService-Info.plist`

Ensure the file is at `ios/Runner/GoogleService-Info.plist` and is added to Xcode project:

1. Open `ios/Runner.xcworkspace` in Xcode
2. Right-click on `Runner` folder
3. Select **Add Files to "Runner"**
4. Select `GoogleService-Info.plist`
5. Ensure "Copy items if needed" is checked

#### Add URL Scheme for Google Sign-In

In `ios/Runner/Info.plist`:

```xml
<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleTypeRole</key>
    <string>Editor</string>
    <key>CFBundleURLSchemes</key>
    <array>
      <!-- Get this from GoogleService-Info.plist REVERSED_CLIENT_ID -->
      <string>com.googleusercontent.apps.YOUR_CLIENT_ID</string>
    </array>
  </dict>
</array>

<!-- Required for Google Sign-In -->
<key>GIDClientID</key>
<string>YOUR_CLIENT_ID.apps.googleusercontent.com</string>
```

### 7.3 Android TV / Fire TV

Android TV and Fire TV use the same Android configuration. Additional considerations:

1. **Leanback Support**: Ensure Firebase UI components work with D-pad navigation
2. **No Google Play Services on Fire TV**: Google Sign-In may not work on Fire TV; use email/password or anonymous auth as fallback

---

## 8. Testing the Integration

### 8.1 Run the App

```bash
# Get dependencies
flutter pub get

# Run on Android
flutter run -d android

# Run on iOS
flutter run -d ios
```

### 8.2 Verify Firebase Connection

Check the debug console for:

```
I/flutter: Firebase initialized successfully
I/flutter: Signed in anonymously: [user-id]
```

### 8.3 Test Authentication

1. App should sign in anonymously on first launch
2. Check Firebase Console > Authentication > Users for new anonymous user
3. Test email/password sign-up
4. Test Google Sign-In

### 8.4 Test Firestore

1. Add a playlist in the app
2. Check Firebase Console > Firestore > users/{userId}/playlists
3. Verify the document was created

### 8.5 Test Remote Config

1. Change a parameter in Firebase Console
2. Publish changes
3. Restart the app (or wait for background fetch)
4. Verify the new value is applied

---

## 9. Troubleshooting

### Common Issues

#### "No Firebase App '[DEFAULT]' has been created"

**Cause:** Firebase not initialized before use.

**Solution:** Ensure `bootstrap()` is called with `firebaseOptions`:

```dart
bootstrap(
  formFactor: FormFactor.mobile,
  firebaseOptions: DefaultFirebaseOptions.currentPlatform,
);
```

#### "Google Sign-In failed" on Android

**Cause:** Missing or incorrect SHA-1 fingerprint.

**Solution:**
1. Get SHA-1: `cd android && ./gradlew signingReport`
2. Add to Firebase Console > Project Settings > Android app
3. Download new `google-services.json`
4. Replace existing file
5. Clean and rebuild: `flutter clean && flutter run`

#### "PlatformException(sign_in_failed)" on iOS

**Cause:** Missing URL scheme or client ID.

**Solution:**
1. Verify `GoogleService-Info.plist` is in Xcode project
2. Check `REVERSED_CLIENT_ID` is added to URL schemes in `Info.plist`
3. Verify `GIDClientID` is set in `Info.plist`

#### Firestore permission denied

**Cause:** Security rules blocking access.

**Solution:**
1. Check user is authenticated: `FirebaseAuth.instance.currentUser`
2. Verify rules allow the operation
3. Check the document path matches rules

#### Remote Config values not updating

**Cause:** Fetch interval not elapsed.

**Solution:**
- In debug mode, minimum fetch interval is 5 minutes
- Force fetch: `await remoteConfig.fetchAndActivate()`
- Check Firebase Console for published changes

### Debug Logging

Enable verbose logging for debugging:

```dart
// In bootstrap.dart or main.dart
import 'package:firebase_core/firebase_core.dart';

// Enable debug logging
FirebaseFirestore.instance.settings = const Settings(
  persistenceEnabled: true,
  // Enable logging in debug mode
);
```

### Getting Help

- [Firebase Flutter Documentation](https://firebase.google.com/docs/flutter/setup)
- [FlutterFire GitHub Issues](https://github.com/firebase/flutterfire/issues)
- [Stack Overflow - Firebase Flutter](https://stackoverflow.com/questions/tagged/firebase+flutter)

---

## Appendix A: Environment-Specific Configuration

For different environments (dev, staging, production), you can:

### Option 1: Multiple Firebase Projects

Create separate Firebase projects and use flavor-specific configuration:

```
android/app/src/
  dev/google-services.json
  staging/google-services.json
  prod/google-services.json

ios/config/
  dev/GoogleService-Info.plist
  staging/GoogleService-Info.plist
  prod/GoogleService-Info.plist
```

### Option 2: Single Project with Multiple Apps

Register multiple apps in one Firebase project with different package names:
- `com.kylos.iptv_player.dev`
- `com.kylos.iptv_player.staging`
- `com.kylos.iptv_player`

---

## Appendix B: Security Best Practices

1. **Never commit** `google-services.json` or `GoogleService-Info.plist` to public repositories
2. **Use environment variables** for CI/CD pipelines
3. **Restrict API keys** in Google Cloud Console
4. **Enable App Check** for production to prevent abuse
5. **Monitor usage** in Firebase Console for unusual activity
6. **Regularly rotate** sensitive credentials
7. **Use Firestore security rules** - never use open rules in production

---

## Appendix C: Useful Commands

```bash
# Regenerate Firebase configuration
flutterfire configure

# Check Firebase CLI login status
firebase login:list

# Deploy Firestore rules
firebase deploy --only firestore:rules

# Deploy Remote Config
firebase deploy --only remoteconfig

# View Firestore indexes
firebase firestore:indexes

# Clean Flutter build
flutter clean && flutter pub get
```
