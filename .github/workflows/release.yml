# Kylos IPTV Player - Release Workflow
#
# This workflow orchestrates the full release process when a version tag is pushed.
# It runs all quality checks, builds all platforms, and optionally deploys to stores.
#
# Trigger: Push a tag matching pattern v*.*.* (e.g., v1.0.0, v1.2.3-beta.1)
#
# The workflow:
# 1. Validates the release tag and extracts version info
# 2. Runs full CI checks (analyze, test)
# 3. Builds Android (mobile + TV) and iOS release artifacts
# 4. Creates a GitHub Release with all artifacts
# 5. Optionally deploys to Google Play and TestFlight
#
# Manual control:
# - Use workflow_dispatch for manual releases
# - Control store deployment via inputs

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      deploy_to_stores:
        description: 'Deploy to app stores'
        required: false
        default: false
        type: boolean
      play_store_track:
        description: 'Google Play track'
        required: false
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production

# Ensure only one release runs at a time
concurrency:
  group: release
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  # =============================================================================
  # Validate Release
  # =============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi

          echo "Raw version: $VERSION"

          # Parse version components
          # Support formats: 1.0.0, 1.0.0-beta.1, 1.0.0+123
          VERSION_NAME=$(echo $VERSION | sed 's/+.*//')

          # Calculate version code from version (MAJOR*10000 + MINOR*100 + PATCH)
          # For 1.2.3 -> 10203
          MAJOR=$(echo $VERSION_NAME | cut -d. -f1 | sed 's/-.*//')
          MINOR=$(echo $VERSION_NAME | cut -d. -f2 | sed 's/-.*//')
          PATCH=$(echo $VERSION_NAME | cut -d. -f3 | sed 's/-.*//')
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))

          # Check if prerelease
          if echo "$VERSION_NAME" | grep -qE '(alpha|beta|rc|dev)'; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi

          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "## Release Version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Name**: $VERSION_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code**: $VERSION_CODE" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: $IS_PRERELEASE" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Run Quality Checks
  # =============================================================================
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Run analyzer
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Run code generators
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            flutter pub run build_runner build --delete-conflicting-outputs
          fi

      - name: Run tests
        run: flutter test --coverage

  # =============================================================================
  # Build Android
  # =============================================================================
  build-android:
    name: Build Android
    needs: [validate, quality-check]
    uses: ./.github/workflows/build-android.yml
    with:
      build_type: release
      target_platform: all
      upload_to_play_store: ${{ github.event_name == 'push' || inputs.deploy_to_stores == true }}
      play_store_track: ${{ inputs.play_store_track || 'internal' }}
      version_name: ${{ needs.validate.outputs.version_name }}
      version_code: ${{ needs.validate.outputs.version_code }}
    secrets:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}

  # =============================================================================
  # Build iOS
  # =============================================================================
  build-ios:
    name: Build iOS
    needs: [validate, quality-check]
    uses: ./.github/workflows/build-ios.yml
    with:
      build_type: release
      upload_to_testflight: ${{ github.event_name == 'push' || inputs.deploy_to_stores == true }}
      version_name: ${{ needs.validate.outputs.version_name }}
      version_code: ${{ needs.validate.outputs.version_code }}
    secrets:
      IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
      IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, build-android, build-ios]
    if: always() && needs.validate.result == 'success' && (needs.build-android.result == 'success' || needs.build-ios.result == 'success')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Android Mobile APK
        uses: actions/download-artifact@v4
        with:
          name: android-mobile-release-apk
          path: artifacts/android/
        continue-on-error: true

      - name: Download Android Mobile AAB
        uses: actions/download-artifact@v4
        with:
          name: android-mobile-release-aab
          path: artifacts/android/
        continue-on-error: true

      - name: Download Android TV APK
        uses: actions/download-artifact@v4
        with:
          name: android-tv-release-apk
          path: artifacts/android-tv/
        continue-on-error: true

      - name: Download iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: ios-release
          path: artifacts/ios/
        continue-on-error: true

      - name: Rename artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version_name }}"

          # Rename Android artifacts
          if [ -f artifacts/android/app-release.apk ]; then
            mv artifacts/android/app-release.apk artifacts/kylos-iptv-player-${VERSION}-android.apk
          fi
          if [ -f artifacts/android/app-release.aab ]; then
            mv artifacts/android/app-release.aab artifacts/kylos-iptv-player-${VERSION}-android.aab
          fi

          # Rename TV artifact
          if [ -f artifacts/android-tv/app-release.apk ]; then
            mv artifacts/android-tv/app-release.apk artifacts/kylos-iptv-player-${VERSION}-android-tv.apk
          fi

          # Rename iOS artifact
          if [ -f artifacts/ios/*.ipa ]; then
            for f in artifacts/ios/*.ipa; do
              mv "$f" "artifacts/kylos-iptv-player-${VERSION}-ios.ipa"
              break
            done
          fi

          ls -la artifacts/

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            echo "CHANGELOG=Initial release" >> $GITHUB_ENV
          else
            # Generate changelog from commits
            echo "## Changes since $PREV_TAG" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            cat CHANGELOG.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.version_name }}
          name: Kylos IPTV Player v${{ needs.validate.outputs.version_name }}
          body: |
            ## Kylos IPTV Player v${{ needs.validate.outputs.version_name }}

            ### Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | Android | `kylos-iptv-player-${{ needs.validate.outputs.version_name }}-android.apk` | Android mobile APK |
            | Android TV | `kylos-iptv-player-${{ needs.validate.outputs.version_name }}-android-tv.apk` | Android TV / Fire TV APK |
            | iOS | `kylos-iptv-player-${{ needs.validate.outputs.version_name }}-ios.ipa` | iOS IPA (requires signing) |

            ### Installation

            **Android**: Download the APK and install directly on your device.
            **Android TV / Fire TV**: Sideload the TV APK using ADB.
            **iOS**: Install via TestFlight (if available) or sideload using appropriate tools.

            ---

            ${{ env.CHANGELOG || 'See commit history for changes.' }}

          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: |
            artifacts/*.apk
            artifacts/*.aab
            artifacts/*.ipa
          fail_on_unmatched_files: false

      - name: Summary
        run: |
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ needs.validate.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -la artifacts/ >> $GITHUB_STEP_SUMMARY || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Notify on Failure
  # =============================================================================
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [validate, quality-check, build-android, build-ios, create-release]
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## Release Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more jobs failed during the release process." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY

      # TODO: Add Slack/Discord/Email notification
      # - name: Send Slack notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: failure
      #     fields: repo,message,commit,author,workflow
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
